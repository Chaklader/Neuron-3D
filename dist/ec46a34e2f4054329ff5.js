let ROOM_TO_MODEL = new Map([
        [
            'Room 0',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/entity-classvaluation-1/4869-regal-dr--bonita-springs--fl-34134--usa/no-unit/26/primary/above-grade/level-1/clones/pool/model/iteration_30000.splat',
        ],
        [
            'Room 21',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-1/clones/vip/model/iteration_30000.splat',
        ],
        [
            'Room 20',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-1/clones/club-room/model/iteration_30000.splat',
        ],
        [
            'Room 4',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/27/365-5th-ave-s--naples--fl-34102--usa/301/primary/above-grade/level-1/clones/livingroomnew/model/iteration_30000.splat',
        ],
        [
            'Room 32',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/602-banyan-blvd--naples--fl-34102--usa/no-unit/secondary/detached-garage/above-grade/level-1/clones/room/model/iteration_30000.splat',
        ],
        [
            'Room 12',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-2/clones/fitness/model/iteration_30000.splat',
        ],
        [
            'Room 13',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-2/clones/lounge---loft/model/iteration_30000.splat',
        ],
        [
            'Room 14',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-2/clones/bedroom-3---remote-retake/model/iteration_30000.splat',
        ],
        [
            'Room 15',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-2/clones/m-bar-hallway/model/iteration_30000.splat',
        ],
        [
            'Room 22',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-1/clones/bath-6-wic/model/iteration_30000.splat',
        ],
        [
            'Room 23',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-1/clones/garage/model/iteration_30000.splat',
        ],
        [
            'Room 24',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/584-banyan-blvd--naples--fl-34102--usa/no-unit/primary/above-grade/level-1/clones/prinary-closet/model/iteration_30000.splat',
        ],
        [
            'Room 31',
            'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/no-entity/26/3396-crayton-rd--naples--fl-34103--usa/no-unit/primary/above-grade/level-1/clones/living-room/model/iteration_30000.splat',
        ],
    ]),
    cameras = [
        {
            id: 0,
            img_name: '00002',
            width: 1959,
            height: 1090,
            position: [
                -3.0089893469241797, -0.11086489695181866, -3.7527640949141428,
            ],
            rotation: [
                [0.876134201218856, 0.06925962026449776, 0.47706599800804744],
                [
                    -0.04747421839895102, 0.9972110940209488,
                    -0.057586739349882114,
                ],
                [-0.4797239414934443, 0.027805376500959853, 0.8769787916452908],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 1,
            img_name: '00009',
            width: 1959,
            height: 1090,
            position: [
                -2.5199776022057296, -0.09704735754873686, -3.6247725540304545,
            ],
            rotation: [
                [
                    0.9982731285632193, -0.011928707708098955,
                    -0.05751927260507243,
                ],
                [
                    0.0065061360949636325, 0.9955928229282383,
                    -0.09355533724430458,
                ],
                [0.058381769258182864, 0.09301955098900708, 0.9939511719154457],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 2,
            img_name: '00017',
            width: 1959,
            height: 1090,
            position: [
                -0.7737533667465242, -0.3364271945329695, -2.9358969417573753,
            ],
            rotation: [
                [
                    0.9998813418672372, 0.013742375651625236,
                    -0.0069605529394208224,
                ],
                [
                    -0.014268370388586709, 0.996512943252834,
                    -0.08220929105659476,
                ],
                [0.00580653013657589, 0.08229885200307129, 0.9965907801935302],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 3,
            img_name: '00025',
            width: 1959,
            height: 1090,
            position: [
                1.2198221749590001, -0.2196687861401182, -2.3183162007028453,
            ],
            rotation: [
                [0.9208648867765482, 0.0012010625395201253, 0.389880004297208],
                [-0.06298204172269357, 0.987319521752825, 0.14571693239364383],
                [-0.3847611242348369, -0.1587410451475895, 0.9092635249821667],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 4,
            img_name: '00033',
            width: 1959,
            height: 1090,
            position: [
                1.742387858893817, -0.13848225198886954, -2.0566370113193146,
            ],
            rotation: [
                [
                    0.24669889292141334, -0.08370189346592856,
                    -0.9654706879349405,
                ],
                [0.11343747891376445, 0.9919082664242816, -0.05700815184573074],
                [0.9624300466054861, -0.09545671285663988, 0.2541976029815521],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 5,
            img_name: '00041',
            width: 1959,
            height: 1090,
            position: [
                3.6567309419223935, -0.16470990600750707, -1.3458085590422042,
            ],
            rotation: [
                [0.2341293058324528, -0.02968330457755884, -0.9717522161434825],
                [0.10270823606832301, 0.99469554638321, -0.005638106875665722],
                [0.9667649592295676, -0.09848690996657204, 0.2359360976431732],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 6,
            img_name: '00049',
            width: 1959,
            height: 1090,
            position: [
                3.9013554243203497, -0.2597500978038105, -0.8106154188297828,
            ],
            rotation: [
                [
                    0.6717235545638952, -0.015718162115524837,
                    -0.7406351366386528,
                ],
                [
                    0.055627354673906296, 0.9980224478387622,
                    0.029270992841185218,
                ],
                [0.7387104058127439, -0.060861588786650656, 0.6712695459756353],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 7,
            img_name: '00057',
            width: 1959,
            height: 1090,
            position: [
                4.742994605467533, -0.05591660945412069, 0.9500365976084458,
            ],
            rotation: [
                [-0.17042655709210375, 0.01207080756938, -0.9852964448542146],
                [0.1165090336695526, 0.9931575292530063, -0.00798543433078162],
                [0.9784581921120181, -0.1161568667478904, -0.1706667764862097],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 8,
            img_name: '00065',
            width: 1959,
            height: 1090,
            position: [
                4.34676307626522, 0.08168160516967145, 1.0876221470355405,
            ],
            rotation: [
                [
                    -0.003575447631888379, -0.044792503246552894,
                    -0.9989899137764799,
                ],
                [0.10770152645126597, 0.9931680875192705, -0.04491693593046672],
                [
                    0.9941768441149182, -0.10775333677534978,
                    0.0012732004866391048,
                ],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
        {
            id: 9,
            img_name: '00073',
            width: 1959,
            height: 1090,
            position: [
                3.264984351114202, 0.078974937336732, 1.0117200284114904,
            ],
            rotation: [
                [
                    -0.026919994628162257, -0.1565891128261527,
                    -0.9872968974090509,
                ],
                [0.08444552208239385, 0.983768234577625, -0.1583319754069128],
                [
                    0.9960643893290491, -0.0876350978794554,
                    -0.013259786205163005,
                ],
            ],
            fy: 1164.6601287484507,
            fx: 1159.5880733038064,
        },
    ];
cameras = [
    { fx: 500, fy: 500, position: [0, 0, 0], rotation: [0, 0, 0] },
    { fx: 500, fy: 500, position: [1, 1, 1], rotation: [0, 1, 0] },
    { fx: 500, fy: 500, position: [2, 2, 2], rotation: [1, 0, 0] },
    { fx: 500, fy: 500, position: [3, 3, 3], rotation: [0, 0, 1] },
    { fx: 500, fy: 500, position: [4, 4, 4], rotation: [1, 1, 0] },
];
let camera = cameras[1];
function getProjectionMatrix(e, t, n, a) {
    return [
        [(2 * e) / n, 0, 0, 0],
        [0, (-2 * t) / a, 0, 0],
        [0, 0, 200 / 199.8, 1],
        [0, 0, -40 / 199.8, 0],
    ].flat();
}
function getViewMatrix(e) {
    if (!e || !e.rotation || !e.position)
        return [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];
    const t = e.rotation.flat(),
        n = e.position;
    return [
        [t[0], t[1], t[2], 0],
        [t[3], t[4], t[5], 0],
        [t[6], t[7], t[8], 0],
        [
            -n[0] * t[0] - n[1] * t[3] - n[2] * t[6],
            -n[0] * t[1] - n[1] * t[4] - n[2] * t[7],
            -n[0] * t[2] - n[1] * t[5] - n[2] * t[8],
            1,
        ],
    ].flat();
}
function multiply4(e, t) {
    return [
        t[0] * e[0] + t[1] * e[4] + t[2] * e[8] + t[3] * e[12],
        t[0] * e[1] + t[1] * e[5] + t[2] * e[9] + t[3] * e[13],
        t[0] * e[2] + t[1] * e[6] + t[2] * e[10] + t[3] * e[14],
        t[0] * e[3] + t[1] * e[7] + t[2] * e[11] + t[3] * e[15],
        t[4] * e[0] + t[5] * e[4] + t[6] * e[8] + t[7] * e[12],
        t[4] * e[1] + t[5] * e[5] + t[6] * e[9] + t[7] * e[13],
        t[4] * e[2] + t[5] * e[6] + t[6] * e[10] + t[7] * e[14],
        t[4] * e[3] + t[5] * e[7] + t[6] * e[11] + t[7] * e[15],
        t[8] * e[0] + t[9] * e[4] + t[10] * e[8] + t[11] * e[12],
        t[8] * e[1] + t[9] * e[5] + t[10] * e[9] + t[11] * e[13],
        t[8] * e[2] + t[9] * e[6] + t[10] * e[10] + t[11] * e[14],
        t[8] * e[3] + t[9] * e[7] + t[10] * e[11] + t[11] * e[15],
        t[12] * e[0] + t[13] * e[4] + t[14] * e[8] + t[15] * e[12],
        t[12] * e[1] + t[13] * e[5] + t[14] * e[9] + t[15] * e[13],
        t[12] * e[2] + t[13] * e[6] + t[14] * e[10] + t[15] * e[14],
        t[12] * e[3] + t[13] * e[7] + t[14] * e[11] + t[15] * e[15],
    ];
}
function invert4(e) {
    let t = e[0] * e[5] - e[1] * e[4],
        n = e[0] * e[6] - e[2] * e[4],
        a = e[0] * e[7] - e[3] * e[4],
        o = e[1] * e[6] - e[2] * e[5],
        r = e[1] * e[7] - e[3] * e[5],
        i = e[2] * e[7] - e[3] * e[6],
        s = e[8] * e[13] - e[9] * e[12],
        l = e[8] * e[14] - e[10] * e[12],
        c = e[8] * e[15] - e[11] * e[12],
        d = e[9] * e[14] - e[10] * e[13],
        u = e[9] * e[15] - e[11] * e[13],
        v = e[10] * e[15] - e[11] * e[14],
        p = t * v - n * u + a * d + o * c - r * l + i * s;
    return p
        ? [
              (e[5] * v - e[6] * u + e[7] * d) / p,
              (e[2] * u - e[1] * v - e[3] * d) / p,
              (e[13] * i - e[14] * r + e[15] * o) / p,
              (e[10] * r - e[9] * i - e[11] * o) / p,
              (e[6] * c - e[4] * v - e[7] * l) / p,
              (e[0] * v - e[2] * c + e[3] * l) / p,
              (e[14] * a - e[12] * i - e[15] * n) / p,
              (e[8] * i - e[10] * a + e[11] * n) / p,
              (e[4] * u - e[5] * c + e[7] * s) / p,
              (e[1] * c - e[0] * u - e[3] * s) / p,
              (e[12] * r - e[13] * a + e[15] * t) / p,
              (e[9] * a - e[8] * r - e[11] * t) / p,
              (e[5] * l - e[4] * d - e[6] * s) / p,
              (e[0] * d - e[1] * l + e[2] * s) / p,
              (e[13] * n - e[12] * o - e[14] * t) / p,
              (e[8] * o - e[9] * n + e[10] * t) / p,
          ]
        : null;
}
function rotate4(e, t, n, a, o) {
    let r = Math.hypot(n, a, o);
    (n /= r), (a /= r), (o /= r);
    let i = Math.sin(t),
        s = Math.cos(t),
        l = 1 - s,
        c = n * n * l + s,
        d = a * n * l + o * i,
        u = o * n * l - a * i,
        v = n * a * l - o * i,
        p = a * a * l + s,
        m = o * a * l + n * i,
        f = n * o * l + a * i,
        h = a * o * l - n * i,
        x = o * o * l + s;
    return [
        e[0] * c + e[4] * d + e[8] * u,
        e[1] * c + e[5] * d + e[9] * u,
        e[2] * c + e[6] * d + e[10] * u,
        e[3] * c + e[7] * d + e[11] * u,
        e[0] * v + e[4] * p + e[8] * m,
        e[1] * v + e[5] * p + e[9] * m,
        e[2] * v + e[6] * p + e[10] * m,
        e[3] * v + e[7] * p + e[11] * m,
        e[0] * f + e[4] * h + e[8] * x,
        e[1] * f + e[5] * h + e[9] * x,
        e[2] * f + e[6] * h + e[10] * x,
        e[3] * f + e[7] * h + e[11] * x,
        ...e.slice(12, 16),
    ];
}
function translate4(e, t, n, a) {
    return [
        ...e.slice(0, 12),
        e[0] * t + e[4] * n + e[8] * a + e[12],
        e[1] * t + e[5] * n + e[9] * a + e[13],
        e[2] * t + e[6] * n + e[10] * a + e[14],
        e[3] * t + e[7] * n + e[11] * a + e[15],
    ];
}
function createWorker(e) {
    let t,
        n,
        a = 0,
        o = [],
        r = new Uint32Array(),
        i = 0;
    var s = new Float32Array(1),
        l = new Int32Array(s.buffer);
    function c(e) {
        s[0] = e;
        var t,
            n = l[0],
            a = (n >> 23) & 255,
            o = 8388607 & n;
        return (
            0 == a
                ? (t = 0)
                : a < 113
                  ? ((t = 0),
                    (o |= 8388608),
                    16777216 & (o >>= 113 - a) && ((t = 1), (o = 0)))
                  : a < 142
                    ? (t = a - 112)
                    : ((t = 31), (o = 0)),
            (((n >> 31) & 1) << 15) | (t << 10) | (o >> 13)
        );
    }
    function d(e, t) {
        return (c(e) | (c(t) << 16)) >>> 0;
    }
    function u(n) {
        if (!t) return;
        const s = new Float32Array(t);
        if (i == a) {
            let e = o[2] * n[2] + o[6] * n[6] + o[10] * n[10];
            if (Math.abs(e - 1) < 0.01) return;
        } else
            !(function () {
                if (!t) return;
                const n = new Float32Array(t),
                    o = new Uint8Array(t);
                var r = 2048,
                    i = Math.ceil((2 * a) / r),
                    s = new Uint32Array(r * i * 4),
                    l = new Uint8Array(s.buffer),
                    c = new Float32Array(s.buffer);
                for (let e = 0; e < a; e++) {
                    (c[8 * e + 0] = n[8 * e + 0]),
                        (c[8 * e + 1] = n[8 * e + 1]),
                        (c[8 * e + 2] = n[8 * e + 2]),
                        (l[4 * (8 * e + 7) + 0] = o[32 * e + 24 + 0]),
                        (l[4 * (8 * e + 7) + 1] = o[32 * e + 24 + 1]),
                        (l[4 * (8 * e + 7) + 2] = o[32 * e + 24 + 2]),
                        (l[4 * (8 * e + 7) + 3] = o[32 * e + 24 + 3]);
                    let t = [
                            n[8 * e + 3 + 0],
                            n[8 * e + 3 + 1],
                            n[8 * e + 3 + 2],
                        ],
                        a = [
                            (o[32 * e + 28 + 0] - 128) / 128,
                            (o[32 * e + 28 + 1] - 128) / 128,
                            (o[32 * e + 28 + 2] - 128) / 128,
                            (o[32 * e + 28 + 3] - 128) / 128,
                        ];
                    const r = [
                            1 - 2 * (a[2] * a[2] + a[3] * a[3]),
                            2 * (a[1] * a[2] + a[0] * a[3]),
                            2 * (a[1] * a[3] - a[0] * a[2]),
                            2 * (a[1] * a[2] - a[0] * a[3]),
                            1 - 2 * (a[1] * a[1] + a[3] * a[3]),
                            2 * (a[2] * a[3] + a[0] * a[1]),
                            2 * (a[1] * a[3] + a[0] * a[2]),
                            2 * (a[2] * a[3] - a[0] * a[1]),
                            1 - 2 * (a[1] * a[1] + a[2] * a[2]),
                        ].map((e, n) => e * t[Math.floor(n / 3)]),
                        i = [
                            r[0] * r[0] + r[3] * r[3] + r[6] * r[6],
                            r[0] * r[1] + r[3] * r[4] + r[6] * r[7],
                            r[0] * r[2] + r[3] * r[5] + r[6] * r[8],
                            r[1] * r[1] + r[4] * r[4] + r[7] * r[7],
                            r[1] * r[2] + r[4] * r[5] + r[7] * r[8],
                            r[2] * r[2] + r[5] * r[5] + r[8] * r[8],
                        ];
                    (s[8 * e + 4] = d(4 * i[0], 4 * i[1])),
                        (s[8 * e + 5] = d(4 * i[2], 4 * i[3])),
                        (s[8 * e + 6] = d(4 * i[4], 4 * i[5]));
                }
                e.postMessage({ texdata: s, texwidth: r, texheight: i }, [
                    s.buffer,
                ]);
            })(),
                (i = a);
        console.time('sort');
        let l = -1 / 0,
            c = 1 / 0,
            u = new Int32Array(a);
        for (let e = 0; e < a; e++) {
            let t =
                (4096 *
                    (n[2] * s[8 * e + 0] +
                        n[6] * s[8 * e + 1] +
                        n[10] * s[8 * e + 2])) |
                0;
            (u[e] = t), t > l && (l = t), t < c && (c = t);
        }
        let v = 65536 / (l - c),
            p = new Uint32Array(65536);
        for (let e = 0; e < a; e++) (u[e] = ((u[e] - c) * v) | 0), p[u[e]]++;
        let m = new Uint32Array(65536);
        for (let e = 1; e < 65536; e++) m[e] = m[e - 1] + p[e - 1];
        r = new Uint32Array(a);
        for (let e = 0; e < a; e++) r[m[u[e]]++] = e;
        console.timeEnd('sort'),
            (o = n),
            e.postMessage({ depthIndex: r, viewProj: n, vertexCount: a }, [
                r.buffer,
            ]);
    }
    const v = () => {
        if (!p) {
            p = !0;
            let e = n;
            u(e),
                setTimeout(() => {
                    (p = !1), e !== n && v();
                }, 0);
        }
    };
    let p;
    e.onmessage = (e) => {
        e.data.ply
            ? ((a = 0),
              u(n),
              (t = (function (e) {
                  const t = new Uint8Array(e),
                      n = new TextDecoder().decode(t.slice(0, 10240)),
                      a = n.indexOf('end_header\n');
                  if (a < 0) throw new Error('Unable to read .ply file header');
                  const o = parseInt(/element vertex (\d+)\n/.exec(n)[1]);
                  console.log('Vertex Count', o);
                  let r = 0,
                      i = {},
                      s = {};
                  const l = {
                      double: 'getFloat64',
                      int: 'getInt32',
                      uint: 'getUint32',
                      float: 'getFloat32',
                      short: 'getInt16',
                      ushort: 'getUint16',
                      uchar: 'getUint8',
                  };
                  for (let e of n
                      .slice(0, a)
                      .split('\n')
                      .filter((e) => e.startsWith('property '))) {
                      const [t, n, a] = e.split(' '),
                          o = l[n] || 'getInt8';
                      (s[a] = o),
                          (i[a] = r),
                          (r += parseInt(o.replace(/[^\d]/g, '')) / 8);
                  }
                  console.log('Bytes per row', r, s, i);
                  let c = new DataView(e, a + 11),
                      d = 0;
                  const u = new Proxy(
                      {},
                      {
                          get(e, t) {
                              if (!s[t]) throw new Error(t + ' not found');
                              return c[s[t]](d * r + i[t], !0);
                          },
                      }
                  );
                  console.time('calculate importance');
                  let v = new Float32Array(o),
                      p = new Uint32Array(o);
                  for (d = 0; d < o; d++) {
                      if (((p[d] = d), !s.scale_0)) continue;
                      const e =
                              Math.exp(u.scale_0) *
                              Math.exp(u.scale_1) *
                              Math.exp(u.scale_2),
                          t = 1 / (1 + Math.exp(-u.opacity));
                      v[d] = e * t;
                  }
                  console.timeEnd('calculate importance'),
                      console.time('sort'),
                      p.sort((e, t) => v[t] - v[e]),
                      console.timeEnd('sort');
                  const m = new ArrayBuffer(32 * o);
                  console.time('build buffer');
                  for (let e = 0; e < o; e++) {
                      d = p[e];
                      const t = new Float32Array(m, 32 * e, 3),
                          n = new Float32Array(m, 32 * e + 12, 3),
                          a = new Uint8ClampedArray(m, 32 * e + 12 + 12, 4),
                          o = new Uint8ClampedArray(m, 32 * e + 12 + 12 + 4, 4);
                      if (s.scale_0) {
                          const e = Math.sqrt(
                              u.rot_0 ** 2 +
                                  u.rot_1 ** 2 +
                                  u.rot_2 ** 2 +
                                  u.rot_3 ** 2
                          );
                          (o[0] = (u.rot_0 / e) * 128 + 128),
                              (o[1] = (u.rot_1 / e) * 128 + 128),
                              (o[2] = (u.rot_2 / e) * 128 + 128),
                              (o[3] = (u.rot_3 / e) * 128 + 128),
                              (n[0] = Math.exp(u.scale_0)),
                              (n[1] = Math.exp(u.scale_1)),
                              (n[2] = Math.exp(u.scale_2));
                      } else
                          (n[0] = 0.01),
                              (n[1] = 0.01),
                              (n[2] = 0.01),
                              (o[0] = 255),
                              (o[1] = 0),
                              (o[2] = 0),
                              (o[3] = 0);
                      if (
                          ((t[0] = u.x), (t[1] = u.y), (t[2] = u.z), s.f_dc_0)
                      ) {
                          const e = 0.28209479177387814;
                          (a[0] = 255 * (0.5 + e * u.f_dc_0)),
                              (a[1] = 255 * (0.5 + e * u.f_dc_1)),
                              (a[2] = 255 * (0.5 + e * u.f_dc_2));
                      } else (a[0] = u.red), (a[1] = u.green), (a[2] = u.blue);
                      s.opacity
                          ? (a[3] = (1 / (1 + Math.exp(-u.opacity))) * 255)
                          : (a[3] = 255);
                  }
                  return console.timeEnd('build buffer'), m;
              })(e.data.ply)),
              (a = Math.floor(t.byteLength / 32)),
              postMessage({ buffer: t }))
            : e.data.buffer
              ? ((t = e.data.buffer), (a = e.data.vertexCount))
              : e.data.vertexCount
                ? (a = e.data.vertexCount)
                : e.data.view && ((n = e.data.view), v());
    };
}
const vertexShaderSource =
        '\n#version 300 es\nprecision highp float;\nprecision highp int;\n\nuniform highp usampler2D u_texture;\nuniform mat4 projection, view;\nuniform vec2 focal;\nuniform vec2 viewport;\n\nin vec2 position;\nin int index;\n\nout vec4 vColor;\nout vec2 vPosition;\n\nvoid main () {\n    uvec4 cen = texelFetch(u_texture, ivec2((uint(index) & 0x3ffu) << 1, uint(index) >> 10), 0);\n    vec4 cam = view * vec4(uintBitsToFloat(cen.xyz), 1);\n    vec4 pos2d = projection * cam;\n\n    float clip = 1.2 * pos2d.w;\n    if (pos2d.z < -clip || pos2d.x < -clip || pos2d.x > clip || pos2d.y < -clip || pos2d.y > clip) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n    }\n\n    uvec4 cov = texelFetch(u_texture, ivec2(((uint(index) & 0x3ffu) << 1) | 1u, uint(index) >> 10), 0);\n    vec2 u1 = unpackHalf2x16(cov.x), u2 = unpackHalf2x16(cov.y), u3 = unpackHalf2x16(cov.z);\n    mat3 Vrk = mat3(u1.x, u1.y, u2.x, u1.y, u2.y, u3.x, u2.x, u3.x, u3.y);\n\n    mat3 J = mat3(\n        focal.x / cam.z, 0., -(focal.x * cam.x) / (cam.z * cam.z), \n        0., -focal.y / cam.z, (focal.y * cam.y) / (cam.z * cam.z), \n        0., 0., 0.\n    );\n\n    mat3 T = transpose(mat3(view)) * J;\n    mat3 cov2d = transpose(T) * Vrk * T;\n\n    float mid = (cov2d[0][0] + cov2d[1][1]) / 2.0;\n    float radius = length(vec2((cov2d[0][0] - cov2d[1][1]) / 2.0, cov2d[0][1]));\n    float lambda1 = mid + radius, lambda2 = mid - radius;\n\n    if(lambda2 < 0.0) return;\n    vec2 diagonalVector = normalize(vec2(cov2d[0][1], lambda1 - cov2d[0][0]));\n    vec2 majorAxis = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n    vec2 minorAxis = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n\n    vColor = clamp(pos2d.z/pos2d.w+1.0, 0.0, 1.0) * vec4((cov.w) & 0xffu, (cov.w >> 8) & 0xffu, (cov.w >> 16) & 0xffu, (cov.w >> 24) & 0xffu) / 255.0;\n    vPosition = position;\n\n    vec2 vCenter = vec2(pos2d) / pos2d.w;\n    gl_Position = vec4(\n        vCenter \n        + position.x * majorAxis / viewport \n        + position.y * minorAxis / viewport, 0.0, 1.0);\n\n}\n'.trim(),
    fragmentShaderSource =
        '\n#version 300 es\nprecision highp float;\n\nin vec4 vColor;\nin vec2 vPosition;\n\nout vec4 fragColor;\n\nvoid main () {\n    float A = -dot(vPosition, vPosition);\n    if (A < -4.0) discard;\n    float B = exp(A) * vColor.a;\n    fragColor = vec4(B * vColor.rgb, B);\n}\n\n'.trim();
let actionInterval,
    defaultViewMatrix = [0, 1, 0, 0, -1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
    viewMatrix = defaultViewMatrix;
async function handleRendering(e, t) {
    const n = 32,
        a = e.body.getReader();
    let o = new Uint8Array(e.headers.get('content-length'));
    const r = o.length / n > 5e5 ? 1 : 1 / devicePixelRatio;
    console.log(o.length / n, r);
    const i = new Worker(
            URL.createObjectURL(
                new Blob(['(', createWorker.toString(), ')(self)'], {
                    type: 'application/javascript',
                })
            )
        ),
        s = document.getElementById('canvas'),
        l = document.getElementById('fps');
    let c;
    const d = s.getContext('webgl2', { antialias: !1 }),
        u = d.createShader(d.VERTEX_SHADER);
    d.shaderSource(u, vertexShaderSource),
        d.compileShader(u),
        d.getShaderParameter(u, d.COMPILE_STATUS) ||
            console.error(d.getShaderInfoLog(u));
    const v = d.createShader(d.FRAGMENT_SHADER);
    d.shaderSource(v, fragmentShaderSource),
        d.compileShader(v),
        d.getShaderParameter(v, d.COMPILE_STATUS) ||
            console.error(d.getShaderInfoLog(v));
    const p = d.createProgram();
    d.attachShader(p, u),
        d.attachShader(p, v),
        d.linkProgram(p),
        d.useProgram(p),
        d.getProgramParameter(p, d.LINK_STATUS) ||
            console.error(d.getProgramInfoLog(p)),
        d.disable(d.DEPTH_TEST),
        d.enable(d.BLEND),
        d.blendFuncSeparate(
            d.ONE_MINUS_DST_ALPHA,
            d.ONE,
            d.ONE_MINUS_DST_ALPHA,
            d.ONE
        ),
        d.blendEquationSeparate(d.FUNC_ADD, d.FUNC_ADD);
    const m = d.getUniformLocation(p, 'projection'),
        f = d.getUniformLocation(p, 'viewport'),
        h = d.getUniformLocation(p, 'focal'),
        x = d.getUniformLocation(p, 'view'),
        y = new Float32Array([-2, -2, 2, -2, 2, 2, -2, 2]),
        g = d.createBuffer();
    d.bindBuffer(d.ARRAY_BUFFER, g),
        d.bufferData(d.ARRAY_BUFFER, y, d.STATIC_DRAW);
    const w = d.getAttribLocation(p, 'position');
    d.enableVertexAttribArray(w),
        d.bindBuffer(d.ARRAY_BUFFER, g),
        d.vertexAttribPointer(w, 2, d.FLOAT, !1, 0, 0);
    var M = d.createTexture();
    d.bindTexture(d.TEXTURE_2D, M);
    var b = d.getUniformLocation(p, 'u_texture');
    d.uniform1i(b, 0);
    const E = d.createBuffer(),
        _ = d.getAttribLocation(p, 'index');
    d.enableVertexAttribArray(_),
        d.bindBuffer(d.ARRAY_BUFFER, E),
        d.vertexAttribIPointer(_, 1, d.INT, !1, 0, 0),
        d.vertexAttribDivisor(_, 1);
    const A = () => {
        d.uniform2fv(h, new Float32Array([camera.fx, camera.fy])),
            (c = getProjectionMatrix(
                camera.fx / r,
                camera.fy / r,
                innerWidth,
                innerHeight
            )),
            d.uniform2fv(f, new Float32Array([innerWidth, innerHeight])),
            (d.canvas.width = Math.round(innerWidth / r)),
            (d.canvas.height = Math.round(innerHeight / r)),
            d.viewport(0, 0, d.canvas.width, d.canvas.height),
            d.uniformMatrix4fv(m, !1, c);
    };
    window.addEventListener('resize', A),
        A(),
        (i.onmessage = (e) => {
            if (e.data.buffer) {
                o = new Uint8Array(e.data.buffer);
                const t = new Blob([o.buffer], {
                        type: 'application/octet-stream',
                    }),
                    n = document.createElement('a');
                (n.download = 'model.splat'),
                    (n.href = URL.createObjectURL(t)),
                    document.body.appendChild(n),
                    n.click();
            } else if (e.data.texdata) {
                const { texdata: t, texwidth: n, texheight: a } = e.data;
                d.bindTexture(d.TEXTURE_2D, M),
                    d.texParameteri(
                        d.TEXTURE_2D,
                        d.TEXTURE_WRAP_S,
                        d.CLAMP_TO_EDGE
                    ),
                    d.texParameteri(
                        d.TEXTURE_2D,
                        d.TEXTURE_WRAP_T,
                        d.CLAMP_TO_EDGE
                    ),
                    d.texParameteri(
                        d.TEXTURE_2D,
                        d.TEXTURE_MIN_FILTER,
                        d.NEAREST
                    ),
                    d.texParameteri(
                        d.TEXTURE_2D,
                        d.TEXTURE_MAG_FILTER,
                        d.NEAREST
                    ),
                    d.texImage2D(
                        d.TEXTURE_2D,
                        0,
                        d.RGBA32UI,
                        n,
                        a,
                        0,
                        d.RGBA_INTEGER,
                        d.UNSIGNED_INT,
                        t
                    ),
                    d.activeTexture(d.TEXTURE0),
                    d.bindTexture(d.TEXTURE_2D, M);
            } else if (e.data.depthIndex) {
                const { depthIndex: t, viewProj: n } = e.data;
                d.bindBuffer(d.ARRAY_BUFFER, E),
                    d.bufferData(d.ARRAY_BUFFER, t, d.DYNAMIC_DRAW),
                    (J = e.data.vertexCount);
            }
        });
    let R,
        j,
        L = [];
    window.addEventListener('keydown', (e) => {
        if ((L.includes(e.code) || L.push(e.code), /\d/.test(e.key))) {
            const t = parseInt(e.key);
            t >= 0 && t < cameras.length
                ? ((camera = cameras[t]),
                  camera && camera.rotation && camera.position
                      ? (viewMatrix = getViewMatrix(camera))
                      : console.warn('Invalid camera object at index', t))
                : console.warn('Invalid camera index:', t);
        }
        'KeyV' == e.code
            ? (location.hash =
                  '#' +
                  JSON.stringify(
                      viewMatrix.map((e) => Math.round(100 * e) / 100)
                  ))
            : e.code;
    }),
        window.addEventListener('keyup', (e) => {
            L = L.filter((t) => t !== e.code);
        }),
        window.addEventListener('blur', () => {
            L = [];
        }),
        window.addEventListener(
            'wheel',
            (e) => {
                e.preventDefault();
                const t =
                    1 == e.deltaMode ? 10 : 2 == e.deltaMode ? innerHeight : 1;
                let n = invert4(viewMatrix);
                if (e.shiftKey)
                    n = translate4(
                        n,
                        (e.deltaX * t) / innerWidth,
                        (e.deltaY * t) / innerHeight,
                        0
                    );
                else if (e.ctrlKey || e.metaKey) {
                    let a = n[13];
                    (n = translate4(
                        n,
                        0,
                        0,
                        (e.deltaY * t * -10) / innerHeight
                    )),
                        (n[13] = a);
                } else {
                    let a = 4;
                    (n = translate4(n, 0, 0, a)),
                        (n = rotate4(n, (-e.deltaX * t) / innerWidth, 0, 1, 0)),
                        (n = rotate4(n, (e.deltaY * t) / innerHeight, 1, 0, 0)),
                        (n = translate4(n, 0, 0, -a));
                }
                viewMatrix = invert4(n);
            },
            { passive: !1 }
        );
    let T = 0,
        I = 0,
        U = !1;
    function D(e, t) {
        let n = e - R,
            a = t - j;
        if (Math.hypot(n, a) > 75) {
            let e = Math.atan2(a, n);
            (n = 75 * Math.cos(e)), (a = 75 * Math.sin(e));
        }
        joystick.style.transform = `translate(${n}px, ${a}px)`;
        let o = [viewMatrix[2], viewMatrix[6], viewMatrix[10]],
            r = [viewMatrix[0], viewMatrix[4], viewMatrix[8]];
        (T = (n / 75) * 0.1 * r[0]), (I = (a / 75) * 0.1 * o[2]);
    }
    function S() {
        (U = !1),
            (T = 0),
            (I = 0),
            (joystick.style.transform = 'translate(0px, 0px)');
    }
    joystick.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const t = joystick.getBoundingClientRect();
        (R = t.left + t.width / 2),
            (j = t.top + t.height / 2),
            (U = !0),
            D(e.clientX, e.clientY);
    }),
        joystick.addEventListener('mousemove', (e) => {
            U && (e.preventDefault(), D(e.clientX, e.clientY));
        }),
        joystick.addEventListener('mouseup', (e) => {
            e.preventDefault(), S();
        }),
        joystick.addEventListener('mouseleave', (e) => {
            U && S();
        }),
        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const t = joystick.getBoundingClientRect();
            (R = t.left + t.width / 2),
                (j = t.top + t.height / 2),
                (U = !0),
                D(e.touches[0].clientX, e.touches[0].clientY);
        }),
        joystick.addEventListener('touchmove', (e) => {
            U &&
                (e.preventDefault(),
                D(e.touches[0].clientX, e.touches[0].clientY));
        }),
        joystick.addEventListener('touchend', (e) => {
            e.preventDefault(), S();
        }),
        (function e() {
            if (U) {
                let e = invert4(viewMatrix);
                e = translate4(e, T, 0, -I);
                let t = e[12] + 0;
                (t = Math.max(0, Math.min(-2, t))), (e[12] = t);
                let n = e[13] + 0;
                (n = Math.max(-4, Math.min(4, n))), (e[13] = n);
                let a = e[14] + 0;
                (a = Math.max(-9, Math.min(9, a))),
                    (e[14] = a),
                    (viewMatrix = invert4(e));
            }
            requestAnimationFrame(e);
        })();
    let C,
        k,
        P = !1;
    const B = (Math.PI, 0.005);
    let F = '';
    function O(e) {
        e.preventDefault(),
            1 === e.touches.length &&
                ((C = e.touches[0].clientX),
                (k = e.touches[0].clientY),
                (P = !0),
                (F = ''));
    }
    function V(e) {
        if ((e.preventDefault(), P)) {
            const t = e.touches[0].clientX,
                n = e.touches[0].clientY,
                a = t - C,
                o = n - k;
            let r = invert4(viewMatrix),
                i = Math.asin(r[6]);
            if (Math.abs(a) > Math.abs(o))
                Math.abs(a) > 3 &&
                    (('' !== F && 'horizontal' !== F) ||
                        ((r = rotate4(r, -B * a, 0, 1, 0)),
                        (F = 'horizontal')));
            else if (Math.abs(o) > 3 && ('' === F || 'vertical' === F)) {
                const e = Math.PI / 4,
                    t = i + B * o;
                t >= -e && t <= 0 && (r = rotate4(r, B * o, 1, 0, 0)),
                    (F = 'vertical');
            }
            (viewMatrix = invert4(r)), X(), (C = t), (k = n);
        }
    }
    function N(e) {
        e.preventDefault(), (P = !1), (F = '');
    }
    function X() {
        const e = multiply4(c, viewMatrix);
        i.postMessage({ view: e });
    }
    s.addEventListener('touchstart', O, { passive: !1 }),
        s.addEventListener('touchmove', V, { passive: !1 }),
        s.addEventListener('touchend', N, { passive: !1 });
    let K,
        Y,
        z = !1;
    let H = '';
    Math.PI,
        s.addEventListener(
            'mousedown',
            function (e) {
                e.preventDefault(),
                    0 === e.button &&
                        ((K = e.clientX), (Y = e.clientY), (z = !0), (H = ''));
            },
            { passive: !1 }
        ),
        s.addEventListener(
            'mousemove',
            function (e) {
                if ((e.preventDefault(), z)) {
                    const t = e.clientX,
                        n = e.clientY,
                        a = t - K,
                        o = n - Y;
                    let r = invert4(viewMatrix),
                        i = Math.asin(r[6]);
                    if (Math.abs(a) > Math.abs(o))
                        Math.abs(a) > 3 &&
                            (('' !== H && 'horizontal' !== H) ||
                                ((r = rotate4(r, -0.005 * a, 0, 1, 0)),
                                (H = 'horizontal')));
                    else if (
                        Math.abs(o) > 3 &&
                        ('' === H || 'vertical' === H)
                    ) {
                        const e = i + 0.005 * o;
                        e >= -(Math.PI / 4) &&
                            e <= 0 &&
                            (r = rotate4(r, 0.005 * o, 1, 0, 0)),
                            (H = 'vertical');
                    }
                    (viewMatrix = invert4(r)), X(), (K = t), (Y = n);
                }
            },
            { passive: !1 }
        ),
        s.addEventListener(
            'mouseup',
            function (e) {
                e.preventDefault(), (z = !1), (H = '');
            },
            { passive: !1 }
        ),
        document.addEventListener('DOMContentLoaded', function () {
            (s = document.getElementById('canvas')),
                s.addEventListener('touchstart', O, { passive: !1 }),
                s.addEventListener('touchmove', V, { passive: !1 }),
                s.addEventListener('touchend', N, { passive: !1 });
        }),
        (altX = 0),
        (altY = 0);
    let W,
        G,
        q = 0,
        J = 0,
        $ = 0,
        Q = 0,
        Z = 0;
    window.addEventListener('gamepadconnected', (e) => {
        const t = navigator.getGamepads()[e.gamepad.index];
        console.log(
            `Gamepad connected at index ${t.index}: ${t.id}. It has ${t.buttons.length} buttons and ${t.axes.length} axes.`
        );
    }),
        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected');
        });
    const ee = (e) => {
        let t = invert4(viewMatrix);
        L.includes('ArrowUp') && (t = translate4(t, 0, 0, 0.1)),
            L.includes('ArrowDown') && (t = translate4(t, 0, 0, -0.1)),
            L.includes('ArrowLeft') && (t = translate4(t, -0.03, 0, 0)),
            L.includes('ArrowRight') && (t = translate4(t, 0.03, 0, 0)),
            L.includes('KeyA') && (t = rotate4(t, -0.01, 0, 1, 0)),
            L.includes('KeyD') && (t = rotate4(t, 0.01, 0, 1, 0)),
            L.includes('KeyQ') && (t = rotate4(t, 0.01, 0, 0, 1)),
            L.includes('KeyE') && (t = rotate4(t, -0.01, 0, 0, 1)),
            L.includes('KeyW') && (t = rotate4(t, 0.005, 1, 0, 0)),
            L.includes('KeyS') && (t = rotate4(t, -0.005, 1, 0, 0));
        const a = navigator.getGamepads ? navigator.getGamepads() : [];
        let r = L.includes('KeySpace');
        for (let e of a) {
            if (!e) continue;
            const n = 0.1,
                a = 0.06,
                o = 0.02;
            Math.abs(e.axes[0]) > n && (t = translate4(t, a * e.axes[0], 0, 0)),
                Math.abs(e.axes[1]) > n &&
                    (t = translate4(t, 0, 0, -a * e.axes[1])),
                (e.buttons[12].pressed || e.buttons[13].pressed) &&
                    (t = translate4(
                        t,
                        0,
                        -a * (e.buttons[12].pressed - e.buttons[13].pressed),
                        0
                    )),
                (e.buttons[14].pressed || e.buttons[15].pressed) &&
                    (t = translate4(
                        t,
                        -a * (e.buttons[14].pressed - e.buttons[15].pressed),
                        0,
                        0
                    )),
                Math.abs(e.axes[2]) > n &&
                    (t = rotate4(t, o * e.axes[2], 0, 1, 0)),
                Math.abs(e.axes[3]) > n &&
                    (t = rotate4(t, -o * e.axes[3], 1, 0, 0));
            let i = e.buttons[6].value - e.buttons[7].value;
            Math.abs(i) > n && (t = rotate4(t, o * i, 0, 0, 1)),
                e.buttons[4].pressed &&
                    !W &&
                    ((camera =
                        cameras[
                            (cameras.indexOf(camera) + 1) % cameras.length
                        ]),
                    (t = invert4(getViewMatrix(camera)))),
                e.buttons[5].pressed &&
                    !G &&
                    ((camera =
                        cameras[
                            (cameras.indexOf(camera) + cameras.length - 1) %
                                cameras.length
                        ]),
                    (t = invert4(getViewMatrix(camera)))),
                (W = e.buttons[4].pressed),
                (G = e.buttons[5].pressed),
                e.buttons[0].pressed && (r = !0),
                e.buttons[3].pressed;
        }
        if (['KeyJ', 'KeyK', 'KeyL', 'KeyI'].some((e) => L.includes(e))) {
            let e = 4;
            (t = translate4(t, 0, 0, e)),
                (t = rotate4(
                    t,
                    L.includes('KeyJ') ? -0.05 : L.includes('KeyL') ? 0.05 : 0,
                    0,
                    1,
                    0
                )),
                (t = rotate4(
                    t,
                    L.includes('KeyI') ? 0.05 : L.includes('KeyK') ? -0.05 : 0,
                    1,
                    0,
                    0
                )),
                (t = translate4(t, 0, 0, -e));
        }
        (viewMatrix = invert4(t)),
            (q = r ? Math.min(1, q + 0.05) : Math.max(0, q - 0.05));
        let s = invert4(viewMatrix);
        (s[13] -= q), (s = rotate4(s, -0.1 * q, 1, 0, 0));
        let u = invert4(s);
        const v = multiply4(c, u);
        i.postMessage({ view: v }),
            (Q = 0.9 * Q + 0.1 * (1e3 / (e - $) || 0)),
            J > 0
                ? ((document.getElementById('spinner').style.display = 'none'),
                  d.uniformMatrix4fv(x, !1, u),
                  d.clear(d.COLOR_BUFFER_BIT),
                  d.drawArraysInstanced(d.TRIANGLE_FAN, 0, 4, J))
                : (d.clear(d.COLOR_BUFFER_BIT),
                  (document.getElementById('spinner').style.display = ''),
                  (Z = Date.now() + 2e3));
        const p = (100 * J) / (o.length / n);
        p < 100
            ? (document.getElementById('progress').style.width = p + '%')
            : (document.getElementById('progress').style.display = 'none'),
            (l.innerText = Math.round(Q) + ' fps'),
            ($ = e),
            requestAnimationFrame(ee);
    };
    ee(),
        window.addEventListener('hashchange', (e) => {
            try {
                viewMatrix = JSON.parse(
                    decodeURIComponent(location.hash.slice(1))
                );
            } catch (e) {}
        });
    const te = (e) => {
        e.preventDefault(), e.stopPropagation();
    };
    document.addEventListener('dragenter', te),
        document.addEventListener('dragover', te),
        document.addEventListener('dragleave', te),
        document.addEventListener('drop', (e) => {
            e.preventDefault(),
                e.stopPropagation(),
                ((e) => {
                    const t = new FileReader();
                    /\.json$/i.test(e.name)
                        ? ((t.onload = () => {
                              (cameras = JSON.parse(t.result)),
                                  (viewMatrix = getViewMatrix(cameras[0])),
                                  (c = getProjectionMatrix(
                                      camera.fx / r,
                                      camera.fy / r,
                                      s.width,
                                      s.height
                                  )),
                                  d.uniformMatrix4fv(m, !1, c),
                                  console.log('Loaded Cameras');
                          }),
                          t.readAsText(e))
                        : ((oe = !0),
                          (t.onload = () => {
                              (o = new Uint8Array(t.result)),
                                  console.log(
                                      'Loaded',
                                      Math.floor(o.length / n)
                                  ),
                                  112 == o[0] &&
                                  108 == o[1] &&
                                  121 == o[2] &&
                                  10 == o[3]
                                      ? i.postMessage({ ply: o.buffer })
                                      : i.postMessage({
                                            buffer: o.buffer,
                                            vertexCount: Math.floor(
                                                o.length / n
                                            ),
                                        });
                          }),
                          t.readAsArrayBuffer(e));
                })(e.dataTransfer.files[0]);
        });
    let ne = 0,
        ae = -1,
        oe = !1;
    for (;;) {
        const { done: e, value: t } = await a.read();
        if (e || oe) break;
        o.set(t, ne),
            (ne += t.length),
            J > ae &&
                (i.postMessage({
                    buffer: o.buffer,
                    vertexCount: Math.floor(ne / n),
                }),
                (ae = J));
    }
    oe || i.postMessage({ buffer: o.buffer, vertexCount: Math.floor(ne / n) });
}
function populateDropdown() {
    const e = document.getElementById('dropdown');
    ROOM_TO_MODEL.forEach((t, n) => {
        const a = document.createElement('option');
        (a.textContent = n), (a.value = n), e.appendChild(a);
    });
}
function getModelUrl(e) {
    return (
        ROOM_TO_MODEL.get(e) ||
        'https://link.storjshare.io/raw/jvxxeyhejguiei247jpxmx4vluua/neuron-dev-datastore/instaplan-master/no-super-entity/entity-classvaluation-1/4869-regal-dr--bonita-springs--fl-34134--usa/no-unit/26/primary/above-grade/level-1/clones/pool/model/iteration_30000.splat'
    );
}
async function onDropdownChange(e) {
    renderRoom(e.target.value);
}
async function fetchUrl(e) {
    return await fetch(e, { mode: 'cors', credentials: 'omit' });
}
async function renderRoom(e) {
    const t = getModelUrl(e);
    handleRendering(await fetchUrl(t), !0);
}
async function startup() {
    renderRoom('Room 0');
}
function toggleControls() {
    const e = document.querySelectorAll(
            '.control-button:not(.toggle-control-button)'
        ),
        t = document.querySelector('.toggle-control-button'),
        n = 'none' === e[0].style.display;
    e.forEach((e) => {
        e.style.display = n ? 'block' : 'none';
    }),
        (t.textContent = n ? '-' : '+');
}
function resetView() {
    (viewMatrix = [0, 1, 0, 0, -1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]),
        updateViewMatrix();
}
function startAction(e) {
    actionInterval && clearInterval(actionInterval),
        (actionInterval = setInterval(window[e], 50));
}
function stopAction() {
    clearInterval(actionInterval);
}
function rotateW() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, 0.005, 1, 0, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function rotateA() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, -0.01, 0, 1, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function rotateS() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, -0.005, 1, 0, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function rotateD() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, 0.01, 0, 1, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function rotateQ() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, 0.01, 0, 0, 1)),
        console.log('q', viewMatrix),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function rotateE() {
    let e = invert4(viewMatrix);
    (e = rotate4(e, -0.01, 0, 0, 1)),
        console.log('e', viewMatrix),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function moveUp() {
    let e = invert4(viewMatrix);
    (e = translate4(e, 0, -0.1, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function moveDown() {
    let e = invert4(viewMatrix);
    (e = translate4(e, 0, 0.1, 0)),
        (viewMatrix = invert4(e)),
        updateViewMatrix();
}
function updateViewMatrix() {
    const e = invert4(viewMatrix),
        t = invert4(e),
        n = multiply4(projectionMatrix, t);
    gl.uniformMatrix4fv(u_view, !1, t), worker.postMessage({ view: n });
}
async function main() {
    let e = !0;
    try {
        (viewMatrix = JSON.parse(decodeURIComponent(location.hash.slice(1)))),
            (e = !1);
    } catch (e) {}
    document.addEventListener('DOMContentLoaded', () => {
        populateDropdown(),
            startup(),
            document
                .getElementById('dropdown')
                .addEventListener('change', onDropdownChange),
            document
                .getElementById('dropdown')
                .addEventListener('keydown', (e) => {
                    e.preventDefault();
                });
    });
}
document.addEventListener('DOMContentLoaded', () => {
    document
        .querySelectorAll('.control-button:not(.toggle-control-button)')
        .forEach((e) => {
            e.style.display = 'block';
        }),
        (document.querySelector('.toggle-control-button').textContent = '-');
}),
    main().catch((e) => {
        (document.getElementById('spinner').style.display = 'none'),
            (document.getElementById('message').innerText = e.toString());
    });
